#!/bin/sh
################################################
#
#              Generated by Chef
#
################################################
<% subnet = @node[:bcpc][:management][:subnet] %>
# Add default routes as a safety net, then remove all at the end
ip route add default via <%=@node["bcpc"]["networks"][subnet]["management"]["gateway"]%> \
         dev <%=@node["bcpc"]["networks"][subnet]["management"]["interface"]%> \
         table main
ip route add <%=@node["bcpc"]["networks"][subnet]["management"]["cidr"]%> \
         dev <%=@node["bcpc"]["networks"][subnet]["management"]["interface"]%> \
         scope link src <%=@node["bcpc"]["management"]["ip"]%> \
         table main

# Build routing table for management network
ip route flush table mgmt
ip route add default via <%=@node["bcpc"]["networks"][subnet]["management"]["gateway"]%> \
         dev <%=@node["bcpc"]["networks"][subnet]["management"]["interface"]%> \
         table mgmt 
ip route add <%=@node["bcpc"]["networks"][subnet]["management"]["cidr"]%> \
         dev <%=@node["bcpc"]["networks"][subnet]["management"]["interface"]%> \
         scope link src <%=@node["bcpc"]["management"]["ip"]%> \
         table mgmt

# Activate this routing table for management traffic
ip rule del pref 10000
ip rule del pref 10001
ip rule add from <%=@node["bcpc"]["networks"][subnet]["management"]["cidr"]%> pref 10000 table mgmt
ip rule add to <%=@node["bcpc"]["networks"][subnet]["management"]["cidr"]%> pref 10001 table mgmt

# Drop all routes to other networks from the main routing table
# XXX: The following line is intentionally duplicated to remove multiple default routes
ip route del default dev <%=@node["bcpc"]["networks"][subnet]["management"]["interface"]%> \
         table main
ip route del default dev <%=@node["bcpc"]["networks"][subnet]["management"]["interface"]%> \
         table main
ip route del <%=@node["bcpc"]["networks"][subnet]["management"]["cidr"]%> \
         dev <%=@node["bcpc"]["networks"][subnet]["management"]["interface"]%> \
         table main

# Flush the route cache to make sure these are active
ip route flush cache
